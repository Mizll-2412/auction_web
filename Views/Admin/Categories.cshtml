@model IEnumerable<BTL_LTWNC.Models.TblCategory>
@{
    ViewData["Title"] = "Quản lý danh mục";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    .category-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 8px;
    }

    code {
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 3px;
        color: #e83e8c;
    }

    .image-preview {
        max-width: 200px;
        max-height: 200px;
        margin-top: 10px;
        border-radius: 8px;
        display: none;
    }
</style>

<div class="top-bar">
    <h1 class="page-title">Quản lý danh mục</h1>
    <p class="page-subtitle">Quản lý danh mục sản phẩm</p>
</div>

<div class="actions-bar mb-3">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <input type="text" id="searchCategory" placeholder="Tìm kiếm danh mục..." 
                   class="form-control" onkeyup="searchCategories()" style="width: 300px;">
        </div>
        <div>
            <button class="btn btn-success" onclick="openAddCategoryForm()">
                <i class="bi bi-plus-circle"></i> Thêm danh mục
            </button>
        </div>
    </div>
</div>

<div class="data-table">
    <table id="categoryTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Hình ảnh</th>
                <th>Tên danh mục</th>
                <th>Mô tả</th>
                <th>Số lượng sản phẩm</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                @foreach (var category in Model)
                {
                    <tr id="category-row-@category.ICategoryId">
                        <td>@category.ICategoryId</td>
                        <td>
                            @if (!string.IsNullOrEmpty(category.ImageUrl))
                            {
                                <img src="@category.ImageUrl" alt="@category.SCategoryName" class="category-image">
                            }
                            else
                            {
                                <div class="category-image d-flex align-items-center justify-content-center bg-secondary text-white">
                                    <i class="bi bi-image"></i>
                                </div>
                            }
                        </td>
                        <td>
                            <strong>@category.SCategoryName</strong>
                        </td>
                        <td>@(category.SDescription ?? "Chưa có mô tả")</td>
                        <td>
                            <span class="badge bg-primary">@(category.TblProducts?.Count ?? 0)</span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-warning" onclick="editCategory(@category.ICategoryId)" title="Sửa">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCategory(@category.ICategoryId)" title="Xóa">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6" class="text-center" style="padding: 40px;">
                        <i class="bi bi-inbox fs-1 text-muted"></i>
                        <p class="text-muted mt-2">Chưa có danh mục nào</p>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Add/Edit Category Modal -->
<div id="categoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="categoryModalTitle">Thêm danh mục</h3>
            <button class="close-btn" onclick="closeCategoryModal()">&times;</button>
        </div>
        <form id="categoryForm" onsubmit="event.preventDefault(); saveCategory();">
            <input type="hidden" id="categoryId">
            
            <div class="form-group">
                <label for="categoryName">Tên danh mục *</label>
                <input type="text" class="form-control" id="categoryName" required>
            </div>

            <div class="form-group">
                <label for="categoryDescription">Mô tả</label>
                <textarea class="form-control" id="categoryDescription" rows="3" 
                          placeholder="Nhập mô tả cho danh mục..."></textarea>
            </div>

            <div class="form-group">
                <label for="categoryImageUrl">URL hình ảnh</label>
                <input type="text" class="form-control" id="categoryImageUrl" 
                       placeholder="https://example.com/image.jpg"
                       onchange="previewImage()">
                <small class="text-muted">Nhập URL của hình ảnh danh mục</small>
                <img id="imagePreview" class="image-preview" alt="Preview">
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">Hủy</button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Lưu
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        function previewImage() {
            const url = document.getElementById('categoryImageUrl').value;
            const preview = document.getElementById('imagePreview');
            
            if (url) {
                preview.src = url;
                preview.style.display = 'block';
                preview.onerror = function() {
                    this.style.display = 'none';
                    alert('Không thể tải hình ảnh. Vui lòng kiểm tra URL.');
                };
            } else {
                preview.style.display = 'none';
            }
        }

        function searchCategories() {
            const input = document.getElementById('searchCategory');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('categoryTable');
            const rows = table.getElementsByTagName('tr');

            for (let i = 1; i < rows.length; i++) {
                const nameCell = rows[i].getElementsByTagName('td')[2];
                const descCell = rows[i].getElementsByTagName('td')[3];
                
                if (nameCell || descCell) {
                    const nameText = nameCell ? nameCell.textContent || nameCell.innerText : '';
                    const descText = descCell ? descCell.textContent || descCell.innerText : '';
                    
                    if (nameText.toLowerCase().indexOf(filter) > -1 || 
                        descText.toLowerCase().indexOf(filter) > -1) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            }
        }

        function openAddCategoryForm() {
            document.getElementById('categoryModalTitle').textContent = 'Thêm danh mục';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('categoryModal').style.display = 'block';
        }

        function editCategory(id) {
            fetch(`/Admin/GetCategoryDetail?id=${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('categoryModalTitle').textContent = 'Sửa danh mục';
                        document.getElementById('categoryId').value = data.category.iCategoryId;
                        document.getElementById('categoryName').value = data.category.sCategoryName;
                        document.getElementById('categoryDescription').value = data.category.sDescription || '';
                        document.getElementById('categoryImageUrl').value = data.category.imageUrl || '';
                        
                        // Preview image if exists
                        if (data.category.imageUrl) {
                            previewImage();
                        }
                        
                        document.getElementById('categoryModal').style.display = 'block';
                    } else {
                        alert('Không thể lấy thông tin danh mục: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Đã xảy ra lỗi khi lấy thông tin danh mục.');
                });
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').style.display = 'none';
        }

        function saveCategory() {
            const categoryId = document.getElementById('categoryId').value;
            const data = {
                ICategoryId: categoryId ? parseInt(categoryId) : 0,
                SCategoryName: document.getElementById('categoryName').value.trim(),
                SDescription: document.getElementById('categoryDescription').value.trim(),
                ImageUrl: document.getElementById('categoryImageUrl').value.trim()
            };

            // Validation
            if (!data.SCategoryName) {
                alert('Vui lòng nhập tên danh mục');
                return;
            }

            const url = categoryId ? '/Admin/UpdateCategory' : '/Admin/CreateCategory';
            
            fetch(url, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(categoryId ? 'Cập nhật danh mục thành công!' : 'Thêm danh mục thành công!');
                    closeCategoryModal();
                    location.reload();
                } else {
                    alert('Lỗi: ' + (result.message || 'Không thể lưu danh mục'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Đã xảy ra lỗi khi lưu danh mục.');
            });
        }

        function deleteCategory(id) {
            if (confirm('Bạn có chắc chắn muốn xóa danh mục này?\n\nLưu ý: Các sản phẩm thuộc danh mục này sẽ không còn danh mục.')) {
                fetch(`/Admin/DeleteCategory?id=${id}`, { 
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        document.getElementById(`category-row-${id}`).remove();
                        alert('Xóa danh mục thành công!');
                        
                        // Check if table is empty
                        const tbody = document.querySelector('#categoryTable tbody');
                        if (tbody.getElementsByTagName('tr').length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="6" class="text-center" style="padding: 40px;">
                                        <i class="bi bi-inbox fs-1 text-muted"></i>
                                        <p class="text-muted mt-2">Chưa có danh mục nào</p>
                                    </td>
                                </tr>
                            `;
                        }
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể xóa danh mục'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Đã xảy ra lỗi khi xóa danh mục.');
                });
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('categoryModal');
            if (event.target === modal) {
                closeCategoryModal();
            }
        }

        // Close modal with ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeCategoryModal();
            }
        });
    </script>
}