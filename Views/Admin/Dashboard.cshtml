@model BTL_LTWNC.ViewModels.DashboardViewModel
@{
    ViewData["Title"] = "Thống kê hệ thống";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
<style>
    .chart-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        height: 400px;
    }

    .chart-card h3 {
        margin-bottom: 20px;
        color: #333;
        font-size: 18px;
    }

    .chart-card canvas {
        max-height: 320px;
    }

    .stat-card small {
        display: block;
        margin-top: 8px;
        font-size: 12px;
    }

    .clear-filter {
        background: none;
        border: 1px solid #ddd;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        color: #666;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s;
    }

    .clear-filter:hover {
        background: #f5f5f5;
        border-color: #999;
    }
</style>
<div class="top-bar">
    <h1 class="page-title">Thống kê hệ thống</h1>
    <p class="page-subtitle">Tổng quan về hoạt động của hệ thống</p>
</div>

<div class="filter-section">
    <div class="filter-group">
        <label>Loại lọc</label>
        <select id="filterType" onchange="updateDashboard()">
            <option value="year">Theo năm</option>
            <option value="month">Theo tháng</option>
            <option value="week">Theo tuần</option>
            <option value="day">Theo ngày</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Năm</label>
        <select id="filterYear" onchange="updateDashboard()">
            <option value="2026">2026</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
        </select>
    </div>
    <div class="filter-group" id="monthFilter" style="display: none;">
        <label>Tháng</label>
        <select id="filterMonth" onchange="updateDashboard()">
            @for (int i = 1; i <= 12; i++)
            {
                <option value="@i">Tháng @i</option>
            }
        </select>
    </div>
    <div>
        <button class="clear-filter" onclick="clearFilter()">
            <i class="bi bi-x-circle"></i> Xóa bỏ lọc
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="bi bi-people"></i>
            </div>
            <div class="stat-info">
                <h3 id="totalUsers">@Model.TotalUsers</h3>
                <p>Tổng người dùng</p>
                <small class="text-success">
                    <i class="bi bi-arrow-up"></i> +@Model.NewUsersThisMonth người mới
                </small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon green">
                <i class="bi bi-file-text"></i>
            </div>
            <div class="stat-info">
                <h3 id="totalPosts">@Model.TotalPosts</h3>
                <p>Tổng bài đăng</p>
                <small class="text-success">
                    <i class="bi bi-arrow-up"></i> +@Model.NewPostsThisMonth bài mới
                </small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon cyan">
                <i class="bi bi-box-seam"></i>
            </div>
            <div class="stat-info">
                <h3 id="totalProducts">@Model.TotalProducts</h3>
                <p>Tổng sản phẩm</p>
                <small class="text-warning">
                    <i class="bi bi-exclamation-circle"></i> @Model.LowStockProducts sản phẩm sắp hết
                </small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon yellow">
                <i class="bi bi-star-fill"></i>
            </div>
            <div class="stat-info">
                <h3 id="totalReviews">@Model.TotalReviews</h3>
                <p>Tổng đánh giá</p>
                <small class="text-info">
                    <i class="bi bi-star"></i> Trung bình @Model.AverageRating/5
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="chart-card">
            <h3>Thống kê người dùng theo tháng</h3>
            <canvas id="userChart"></canvas>
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-card">
            <h3>Thống kê bài đăng theo trạng thái</h3>
            <canvas id="postChart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Activities -->
<div class="row g-3">
    <div class="col-md-6">
        <div class="data-table">
            <div class="table-header">
                <h3>Người dùng mới đăng ký</h3>
                <a asp-controller="Admin" asp-action="Users" class="btn btn-sm btn-primary">Xem tất cả</a>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Tên</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model.RecentUsers)
                    {
                        <tr>
                            <td>@user.SFullName</td>
                            <td>@user.SEmail</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="col-md-6">
        <div class="data-table">
            <div class="table-header">
                <h3>Bài đăng chờ duyệt</h3>
                <a asp-controller="Admin" asp-action="Posts" class="btn btn-sm btn-warning">Xem tất cả</a>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Tiêu đề</th>
                        <th>Tác giả</th>
                        <th>Ngày tạo</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var post in Model.PendingPosts)
                    {
                        <tr>
                            <td>@post.Title</td>
                            <td>@post.AuthorName</td>
                            <td>@post.CreatedAt.ToString("dd/MM/yyyy")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Filter handling
        document.getElementById('filterType').addEventListener('change', function() {
            const monthFilter = document.getElementById('monthFilter');
            if (this.value === 'month') {
                monthFilter.style.display = 'block';
            } else {
                monthFilter.style.display = 'none';
            }
        });

        function clearFilter() {
            document.getElementById('filterType').value = 'year';
            document.getElementById('filterYear').value = '2026';
            document.getElementById('monthFilter').style.display = 'none';
            updateDashboard();
        }

        function updateDashboard() {
            const filterType = document.getElementById('filterType').value;
            const filterYear = document.getElementById('filterYear').value;
            const filterMonth = document.getElementById('filterMonth')?.value;

            fetch(`/Admin/GetDashboardData?type=${filterType}&year=${filterYear}&month=${filterMonth || ''}`)
                .then(response => response.json())
                .then(data => {
                    // Update stats
                    document.getElementById('totalUsers').textContent = data.totalUsers;
                    document.getElementById('totalPosts').textContent = data.totalPosts;
                    document.getElementById('totalProducts').textContent = data.totalProducts;
                    document.getElementById('totalReviews').textContent = data.totalReviews;
                    
                    // Update charts
                    updateCharts(data);
                });
        }

        // User Chart
        const userCtx = document.getElementById('userChart').getContext('2d');
        const userChart = new Chart(userCtx, {
            type: 'line',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.UserChartLabels)),
                datasets: [{
                    label: 'Người dùng mới',
                    data: @Html.Raw(Json.Serialize(Model.UserChartData)),
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true }
                }
            }
        });

        // Post Chart
        const postCtx = document.getElementById('postChart').getContext('2d');
        const postChart = new Chart(postCtx, {
            type: 'doughnut',
            data: {
                labels: ['Đang diễn ra', 'Sắp diễn ra', 'Sẽ diễn ra', 'Đã kết thúc'],
                datasets: [{
                    data: @Html.Raw(Json.Serialize(Model.PostStatusData)),
                    backgroundColor: ['#4CAF50', '#FFC107', '#2196F3', '#9E9E9E']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        function updateCharts(data) {
            userChart.data.labels = data.chartLabels;
            userChart.data.datasets[0].data = data.userChartData;
            userChart.update();

            postChart.data.datasets[0].data = data.postStatusData;
            postChart.update();
        }
    </script>
}
