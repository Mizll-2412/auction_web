@model IEnumerable<BTL_LTWNC.Models.TblAuction>
@{
    ViewData["Title"] = "Quản lý phiên đấu giá";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var role = ViewBag.Role;
}

<style>
    .product-thumb {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 8px;
    }

    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
    }

    .nav-tabs .nav-link {
        border: none;
        color: #666;
        padding: 12px 20px;
        transition: all 0.3s;
    }

    .nav-tabs .nav-link.active {
        color: #2196F3;
        border-bottom: 2px solid #2196F3;
        background: none;
    }

    .nav-tabs .nav-link:hover {
        color: #2196F3;
    }

    .modal-lg {
        max-width: 900px;
    }

    .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }

    .auction-detail img {
        max-width: 100%;
        border-radius: 10px;
    }

    .price-badge {
        font-size: 16px;
        font-weight: bold;
    }
</style>

<div class="top-bar">
    <h1 class="page-title">Quản lý phiên đấu giá</h1>
    <p class="page-subtitle">Danh sách các phiên đấu giá trong hệ thống</p>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-3" id="auctionTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button">
            <i class="bi bi-list-ul"></i> Tất cả phiên đấu giá (@(Model?.Count() ?? 0))
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button">
            <i class="bi bi-activity"></i> Đang diễn ra (@(Model?.Count(a => a.SStatus == "active") ?? 0))
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="ended-tab" data-bs-toggle="tab" data-bs-target="#ended" type="button">
            <i class="bi bi-check-circle"></i> Đã kết thúc (@(Model?.Count(a => a.SStatus == "ended") ?? 0))
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="auctionTabContent">
    <!-- All Auctions Tab -->
    <div class="tab-pane fade show active" id="all" role="tabpanel">
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-group">
                <label>Tìm kiếm</label>
                <input type="text" id="searchInput" placeholder="Tìm theo sản phẩm..." 
                       class="form-control" onkeyup="filterAuctions()">
            </div>
            <div class="filter-group">
                <label>Trạng thái</label>
                <select id="statusFilter" onchange="filterAuctions()">
                    <option value="">Tất cả trạng thái</option>
                    <option value="pending">Chờ bắt đầu</option>
                    <option value="active">Đang diễn ra</option>
                    <option value="ended">Đã kết thúc</option>
                    <option value="cancelled">Đã hủy</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Thời gian</label>
                <select id="timeFilter" onchange="filterAuctions()">
                    <option value="">Tất cả</option>
                    <option value="today">Hôm nay</option>
                    <option value="week">Tuần này</option>
                    <option value="month">Tháng này</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Sắp xếp</label>
                <select id="sortFilter" onchange="sortAuctions()">
                    <option value="newest">Mới nhất</option>
                    <option value="ending_soon">Sắp kết thúc</option>
                    <option value="highest_bid">Giá cao nhất</option>
                    <option value="lowest_bid">Giá thấp nhất</option>
                </select>
            </div>
            <div>
                <label>&nbsp;</label>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <i class="bi bi-x-circle"></i> Xóa lọc
                </button>
            </div>
        </div>

        <!-- Actions Bar -->
        <div class="actions-bar mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="text-muted">Hiển thị <strong id="showingCount">@(Model?.Count() ?? 0)</strong> phiên đấu giá</span>
                </div>
                <div>
                    <button class="btn btn-success" onclick="openAddAuctionForm()">
                        <i class="bi bi-plus-circle"></i> Tạo phiên đấu giá
                    </button>
                    <button class="btn btn-primary" onclick="exportAuctions()">
                        <i class="bi bi-download"></i> Xuất Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Auctions Table -->
        <div class="data-table">
            <table id="auctionsTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th>ID</th>
                        <th>Sản phẩm</th>
                        <th>Thời gian bắt đầu</th>
                        <th>Thời gian kết thúc</th>
                        <th>Giá cao nhất</th>
                        <th>Người thắng</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        @foreach (var auction in Model)
                        {
                            <tr id="auction-row-@auction.IAuctionId" 
                                data-status="@auction.SStatus"
                                data-start="@auction.DtStartTime?.ToString("yyyy-MM-dd")"
                                data-end="@auction.DtEndTime?.ToString("yyyy-MM-dd")">
                                <td><input type="checkbox" class="auction-checkbox" value="@auction.IAuctionId"></td>
                                <td>@auction.IAuctionId</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        @if (!string.IsNullOrEmpty(auction.IProduct?.SImageUrl))
                                        {
                                            <img src="@auction.IProduct.SImageUrl" class="product-thumb me-2" alt="product">
                                        }
                                        else
                                        {
                                            <div class="product-thumb me-2 bg-secondary d-flex align-items-center justify-content-center text-white">
                                                <i class="bi bi-image"></i>
                                            </div>
                                        }
                                        <span>@(auction.IProduct?.SProductName ?? "Sản phẩm đã xóa")</span>
                                    </div>
                                </td>
                                <td>@auction.DtStartTime?.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@auction.DtEndTime?.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>
                                    <span class="price-badge text-success">
                                        @((auction.DHighestBid ?? 0).ToString("#,##0")) ₫
                                    </span>
                                </td>
                                <td>
                                    @if (auction.IWinner != null)
                                    {
                                        <div>
                                            <strong>@auction.IWinner.SFullName</strong>
                                            <br>
                                            <small class="text-muted">@auction.IWinner.SEmail</small>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Chưa có</span>
                                    }
                                </td>
                                <td>
                                    @switch (auction.SStatus?.ToLower())
                                    {
                                        case "pending":
                                            <span class="badge bg-warning">Chờ bắt đầu</span>
                                            break;
                                        case "active":
                                            <span class="badge bg-success">Đang diễn ra</span>
                                            break;
                                        case "ended":
                                            <span class="badge bg-secondary">Đã kết thúc</span>
                                            break;
                                        case "cancelled":
                                            <span class="badge bg-danger">Đã hủy</span>
                                            break;
                                        default:
                                            <span class="badge bg-secondary">@auction.SStatus</span>
                                            break;
                                    }
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-info" onclick="viewAuction(@auction.IAuctionId)" title="Xem chi tiết">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        @if (auction.SStatus?.ToLower() != "ended")
                                        {
                                            <button class="btn btn-sm btn-warning" onclick="editAuction(@auction.IAuctionId)" title="Sửa">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                        }
                                        @if (auction.SStatus?.ToLower() == "pending")
                                        {
                                            <button class="btn btn-sm btn-danger" onclick="cancelAuction(@auction.IAuctionId)" title="Hủy">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        }
                                        @if (auction.SStatus?.ToLower() == "active")
                                        {
                                            <button class="btn btn-sm btn-success" onclick="endAuction(@auction.IAuctionId)" title="Kết thúc">
                                                <i class="bi bi-stop-circle"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9" class="text-center" style="padding: 40px;">
                                <i class="bi bi-inbox fs-1 text-muted"></i>
                                <p class="text-muted mt-2">Chưa có phiên đấu giá nào</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Active Auctions Tab -->
    <div class="tab-pane fade" id="active" role="tabpanel">
        <div class="alert alert-success">
            <i class="bi bi-activity"></i> Có <strong>@(Model?.Count(a => a.SStatus == "active") ?? 0)</strong> phiên đấu giá đang diễn ra
        </div>
        <div class="data-table">
            <!-- Same table structure, filtered by active status -->
            <p class="text-muted text-center">Hiển thị các phiên đấu giá đang hoạt động...</p>
        </div>
    </div>

    <!-- Ended Auctions Tab -->
    <div class="tab-pane fade" id="ended" role="tabpanel">
        <div class="alert alert-info">
            <i class="bi bi-check-circle"></i> Có <strong>@(Model?.Count(a => a.SStatus == "ended") ?? 0)</strong> phiên đấu giá đã kết thúc
        </div>
        <div class="data-table">
            <!-- Same table structure, filtered by ended status -->
            <p class="text-muted text-center">Hiển thị các phiên đấu giá đã kết thúc...</p>
        </div>
    </div>
</div>

<!-- Auction Detail Modal -->
<div id="auctionDetailModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3>Chi tiết phiên đấu giá</h3>
            <button class="close-btn" onclick="closeAuctionDetailModal()">&times;</button>
        </div>
        <div id="auctionDetailContent" class="modal-body">
            <!-- Content loaded via AJAX -->
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function filterAuctions() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
            const timeFilter = document.getElementById('timeFilter').value;
            
            const rows = document.querySelectorAll('#auctionsTable tbody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                if (row.cells.length < 9) return; // Skip empty row
                
                const productName = row.cells[2].textContent.toLowerCase();
                const status = row.getAttribute('data-status')?.toLowerCase() || '';
                const startDate = row.getAttribute('data-start');
                
                let showRow = true;
                
                // Search filter
                if (searchInput && !productName.includes(searchInput)) {
                    showRow = false;
                }
                
                // Status filter
                if (statusFilter && status !== statusFilter) {
                    showRow = false;
                }
                
                // Time filter
                if (timeFilter && startDate) {
                    const auctionDate = new Date(startDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    switch(timeFilter) {
                        case 'today':
                            if (auctionDate.toDateString() !== today.toDateString()) showRow = false;
                            break;
                        case 'week':
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            if (auctionDate < weekAgo) showRow = false;
                            break;
                        case 'month':
                            const monthAgo = new Date(today);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            if (auctionDate < monthAgo) showRow = false;
                            break;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
                if (showRow) visibleCount++;
            });
            
            document.getElementById('showingCount').textContent = visibleCount;
        }

        function sortAuctions() {
            const sortValue = document.getElementById('sortFilter').value;
            const tbody = document.querySelector('#auctionsTable tbody');
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.cells.length >= 9);
            
            rows.sort((a, b) => {
                switch(sortValue) {
                    case 'newest':
                        const dateA = new Date(a.getAttribute('data-start') || 0);
                        const dateB = new Date(b.getAttribute('data-start') || 0);
                        return dateB - dateA;
                    case 'ending_soon':
                        const endA = new Date(a.getAttribute('data-end') || 0);
                        const endB = new Date(b.getAttribute('data-end') || 0);
                        return endA - endB;
                    case 'highest_bid':
                        const bidA = parseFloat(a.cells[5].textContent.replace(/[^\d]/g, '') || 0);
                        const bidB = parseFloat(b.cells[5].textContent.replace(/[^\d]/g, '') || 0);
                        return bidB - bidA;
                    case 'lowest_bid':
                        const bidA2 = parseFloat(a.cells[5].textContent.replace(/[^\d]/g, '') || 0);
                        const bidB2 = parseFloat(b.cells[5].textContent.replace(/[^\d]/g, '') || 0);
                        return bidA2 - bidB2;
                    default:
                        return 0;
                }
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('timeFilter').value = '';
            document.getElementById('sortFilter').value = 'newest';
            filterAuctions();
        }

        function viewAuction(auctionId) {
            fetch(`/Admin/GetAuctionDetail?id=${auctionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('auctionDetailContent').innerHTML = `
                            <div class="auction-detail">
                                <div class="row">
                                    <div class="col-md-6">
                                        <img src="${data.auction.productImage}" class="img-fluid" alt="product">
                                    </div>
                                    <div class="col-md-6">
                                        <h4>${data.auction.productName}</h4>
                                        <p class="text-muted">${data.auction.productDescription || ''}</p>
                                        <hr>
                                        <p><strong>Thời gian bắt đầu:</strong> ${data.auction.startTime}</p>
                                        <p><strong>Thời gian kết thúc:</strong> ${data.auction.endTime}</p>
                                        <p><strong>Giá cao nhất:</strong> <span class="text-success fs-4">${data.auction.highestBid} ₫</span></p>
                                        <p><strong>Người thắng:</strong> ${data.auction.winnerName || 'Chưa có'}</p>
                                        <p><strong>Trạng thái:</strong> ${getStatusBadge(data.auction.status)}</p>
                                        <p><strong>Số lượt đấu giá:</strong> ${data.auction.bidCount}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.getElementById('auctionDetailModal').style.display = 'block';
                    } else {
                        alert('Không thể lấy thông tin phiên đấu giá');
                    }
                })
                .catch(() => alert('Đã xảy ra lỗi'));
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge bg-warning">Chờ bắt đầu</span>',
                'active': '<span class="badge bg-success">Đang diễn ra</span>',
                'ended': '<span class="badge bg-secondary">Đã kết thúc</span>',
                'cancelled': '<span class="badge bg-danger">Đã hủy</span>'
            };
            return badges[status?.toLowerCase()] || '<span class="badge bg-secondary">' + status + '</span>';
        }

        function editAuction(id) {
            window.location.href = `/Admin/EditAuction?id=${id}`;
        }

        function cancelAuction(id) {
            if (confirm('Bạn có chắc chắn muốn hủy phiên đấu giá này?')) {
                fetch(`/Admin/CancelAuction?id=${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Đã hủy phiên đấu giá');
                        location.reload();
                    } else {
                        alert('Lỗi: ' + result.message);
                    }
                });
            }
        }

        function endAuction(id) {
            if (confirm('Bạn có chắc chắn muốn kết thúc phiên đấu giá này ngay?')) {
                fetch(`/Admin/EndAuction?id=${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Đã kết thúc phiên đấu giá');
                        location.reload();
                    } else {
                        alert('Lỗi: ' + result.message);
                    }
                });
            }
        }

        function openAddAuctionForm() {
            window.location.href = '/Admin/CreateAuction';
        }

        function exportAuctions() {
            const selected = Array.from(document.querySelectorAll('.auction-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selected.length > 0) {
                window.location.href = `/Admin/ExportAuctions?ids=${selected.join(',')}`;
            } else {
                window.location.href = '/Admin/ExportAuctions';
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.auction-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        function closeAuctionDetailModal() {
            document.getElementById('auctionDetailModal').style.display = 'none';
        }

        // Close modal events
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAuctionDetailModal();
            }
        });
    </script>
}