@{
    ViewData["Title"] = "Home Page";
}
@model BTL_LTWNC.Models.TblAuction;

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

<style>
    .auction-card {
        transition: transform .25s ease, box-shadow .25s ease;
        border-radius: 16px;
        overflow: hidden;
    }

    .auction-card:hover {
        transform: translateY(-6px);
        box-shadow: 0px 10px 25px rgba(0, 0, 0, 0.15);
    }

    .auction-img {
        height: 180px;
        object-fit: cover;
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
    }

    .countdown {
        font-weight: bold;
        color: #d9534f;
        font-size: 14px;
    }
</style>

<main class="container py-4">

    <!-- ==== DANH MỤC ==== -->
    <div class="mb-5">
        <h3 class="fw-bold mb-3">Lối tắt danh mục</h3>

        <div class="row g-3">
            @if (ViewBag.Categories != null)
            {
                foreach (var category in ViewBag.Categories)
                {
                    <div class="col-6 col-md-3 col-lg-2">
                        <a href="javascript:void(0)" class="text-decoration-none text-dark category-link"
                            data-url="@Url.Action("ListProduct", "Product", new { categoryId = category.ICategoryId })">
                            <div class="card shadow-sm h-100 text-center p-2" style="border-radius:16px;">
                                <img src="@category.ImageUrl" loading="lazy" class="img-fluid rounded"
                                    style="height:80px;object-fit:cover;" />
                                <div class="mt-2 fw-semibold">@category.SCategoryName</div>
                            </div>
                        </a>
                    </div>
                }
            }
        </div>
    </div>

    <!-- ==== ĐANG DIỄN RA ==== -->
    <section class="mb-5">
        <h4 class="fw-bold">Đấu giá đang diễn ra</h4>
        <p class="text-muted small"><i>@ViewBag.CurrentAuctions?.Count tài sản</i></p>

        <div class="row g-4">
            @if (ViewBag.CurrentAuctions != null)
            {
                foreach (var auction in ViewBag.CurrentAuctions)
                {
                    <div class="col-12 col-md-6 col-lg-4 col-xl-3">
                        <a href="@Url.Action("Detail", "Auction", 
                                   new { productId = auction.IProductId })" class="text-decoration-none text-dark">

                    <div class="card auction-card shadow-sm">
                        <img src="@auction.IProduct?.SImageUrl" loading="lazy" class="auction-img">

                                <div class="card-body">
                                    <h5 class="fw-bold">@auction.IProduct.SProductName</h5>

                                    <p class="text-danger fw-semibold">
                                        Giá khởi điểm: @auction.IProduct.DStartingPrice VND
                                    </p>

                                    <p class="text-muted small mb-1">
                                        Bắt đầu: @auction.DtStartTime <br />
                                        Kết thúc: @auction.DtEndTime
                                    </p>

                                    <p class="countdown" id="cd-@auction.IAuctionId"></p>

                                    <script>
                                        countdown("@auction.DtEndTime", "cd-@auction.IAuctionId");
                                    </script>
                                </div>
                            </div>

                        </a>
                    </div>
                        }
            }
        </div>
    </section>

</main>
<script>
    const isLoggedIn = @(Context.Session.GetString("UserSession") != null ? "true" : "false");
</script>
<script>
    document.querySelectorAll(".category-link").forEach(el => {
        el.addEventListener("click", function () {

            if (!isLoggedIn) {
                const loginModal = new bootstrap.Modal(
                    document.getElementById("loginModal")
                );
                loginModal.show();
                return;
            }

            window.location.href = this.dataset.url;
        });
    });
</script>
<script>
    /* COUNTDOWN FUNCTION */
    function countdown(endTime, elementId) {
        const end = new Date(endTime).getTime();

        const timer = setInterval(() => {
            const now = new Date().getTime();
            const distance = end - now;

            if (distance <= 0) {
                document.getElementById(elementId).innerHTML = "Đã kết thúc";
                clearInterval(timer);
                return;
            }

            const h = Math.floor((distance / (1000 * 60 * 60)));
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((distance % (1000 * 60)) / 1000);

            document.getElementById(elementId).innerHTML =
                `⏳ ${h} giờ ${m} phút ${s} giây`;
        }, 1000);
    }
</script>